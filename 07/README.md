# DBの運用（RDS）

フルマネージドサービスのDBであるRDSについて書かれています

## RDSって何
- RDS : _Relational Database Service_
- MySQL, PostgresSQL, Oracle, MSSQLが使用できる
- OS管理、パッチ当て、アップデートはAWS側で管理しているので利用が簡単
- オプションとして冗長化、レプリケーションもあり！
- EC2と同様にリージョンとアベイラビリティゾーンの概念がある


## DBインスタンスの構築
#### 1. セキュリティグループの作成
- RDSへ接続するサーバやクライアントの接続元IPアドレスなどを指定し、アクセス制限を設定する

#### 2. DBパラメータグループの作成
- DB設定の詳細を設定する
- ※ RDSはフルマネージドサービスのため、ユーザーが変更できる部分はAWSから提供されている箇所に限られている
- 適用タイプの属性で設定の反映タイミングを設定できる
    - 「dynamic」: DBパラメータを変更した際にRDSインスタンスに動的に反映される
    - 「static」: RDSの再起動後に設定が反映される

#### 3. DBオプショングループ作成
- DBの機能的な部分を設定する
    - MySQLならmemcashedプラグインのなどを追加したり出来る！

#### 4. DBサブネットグループの作成
- VPC内でRDSインスタンスを起動する際に必要な設定
- RDSインスタンスが起動するサブネットを指定した設定
    - VPC内にあるサブネットの1つ or 複数のサブネットを指定する

#### 5. DBインスタンスの起動
- 使うDBを設定する
- 合わせて使用するサブネットグループやパラメータグループを設定する
- EC2と同じ起動時間単位の課金💰

#### 6. クライアントからRDSインスタンスへの接続
- IPアドレスが固定化出来ないため、エンドポイントと呼ばれるFQDNに対して接続する
![image](https://user-images.githubusercontent.com/12966452/34432717-61d77608-ecbd-11e7-979b-d0e2c0b9f925.png)

### タイムゾーンについて
- DBの時間はRDSインスタンスが起動しているOSに依存する
- DBによってはタイムゾーンの変更ができないので注意
- その場合は、datetimeoffsetなどでアプリケーション側で変換する必要ある！

|DBエンジン|タイムゾーンの変更可否|
|:-|:-|
|MySQL|×|
|PostgresSQL|DBパラメータグループから変更可能|
|Oracle|DBオプショングループから変更可能|
|MSSQL|×|

## DBの冗長化について
- DBの耐障害性をあげるために冗長化は非常に大事！
- RDSではオプションとして**マルチAZ配置**、**リードレプリカ**がある

#### マルチAZ配置
- 複数のアベイラビリティゾーンにまたがってRDSインスンタンスを2台作成し、マスタ側に問題が発生した際にスレーブに自動的に切り替わる機能

#### リードレプリカ
- 複数台のRDSインスンタンスを起動し、マスタと同期された読み込み専用のRDSインスタンスを起動する機能
- マルチAZ配置と異なる点
    - 読み込み専用のRDSインスタンスに接続して参照できること
    - アプリケーションからDBの参照はリードレプリカに、更新はマスタにすることでRDSインスタンスの負荷を分散することが出来る！
- リードレプリカをマスタとして独立したRDSとして起動することも可能

## I/Oの高速化について
- I/Oは負荷の上がりやすいポイント
- RDSではプロビジョンドIOPS機能でI/Oを性能を向上できる

## バックアップと復元について
- RDSではスナップショットを使うことで簡単にRDSのバックアップが出来る
- また、スナップショットから簡単にRDSインスタンスの復元が可能
    - ※ 復元の場合は新規にRDSインスタンスを起動する必要がある
- RDSの自動バックアップとAWS側に保存された更新ログを用いて特定時点への復元も可能


## 知見
- AWS側で管理されている分こちらが設定しなくてはいけない箇所がはっきりしていて分かりやすかった
- ただ、運用面で大事になりそうなDBパラメータグループやバックアップ設定などはイメージが湧きづらかったので使用時に意識していきたい
- リードレプリカやプロビジョンドIOPSの設定なども実際に負荷がどのくらい変わるのか気になる